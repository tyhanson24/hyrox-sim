<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout — HYROX SIM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <style>
    .detail-page {
      min-height: 100vh; padding: 6rem 2rem 4rem;
      background: radial-gradient(ellipse at 50% 0%, rgba(200,255,0,.04) 0%, transparent 60%), var(--dark);
    }
    .detail-container { max-width: 800px; margin: 0 auto; }

    .detail-back {
      display: inline-block; color: var(--text-muted); text-decoration: none;
      font-size: .85rem; margin-bottom: 2rem; transition: color .3s;
    }
    .detail-back:hover { color: var(--neon); }

    .detail-header { margin-bottom: 2.5rem; }
    .detail-header h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      color: #fff; letter-spacing: 2px; line-height: 1.1;
    }
    .detail-meta {
      display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;
      align-items: center;
    }
    .detail-meta .badge { font-size: .7rem; }
    .detail-desc {
      color: var(--text-muted); line-height: 1.7; margin-top: 1rem;
      font-size: .95rem;
    }

    .detail-section {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 1.5rem;
    }
    .detail-section h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem; color: #fff; letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }
    .detail-section h2 .accent { color: var(--neon); }

    .exercise-list { list-style: none; }
    .exercise-item {
      display: flex; align-items: flex-start; gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--card-border);
    }
    .exercise-item:last-child { border-bottom: none; }
    .exercise-num {
      width: 36px; height: 36px; flex-shrink: 0;
      background: rgba(200,255,0,.1);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem; color: var(--neon);
    }
    .exercise-info h4 { color: #fff; font-size: .95rem; }
    .exercise-info p { color: var(--text-muted); font-size: .85rem; margin-top: .2rem; }
    .exercise-info .ex-detail {
      display: flex; gap: .8rem; margin-top: .4rem; flex-wrap: wrap;
    }
    .exercise-info .ex-detail span {
      font-size: .7rem; text-transform: uppercase; letter-spacing: 1px;
      color: var(--neon); background: rgba(200,255,0,.08);
      padding: .15rem .5rem;
    }

    .equipment-list {
      display: flex; gap: .5rem; flex-wrap: wrap;
    }
    .equip-tag {
      background: rgba(255,255,255,.05); border: 1px solid var(--card-border);
      padding: .4rem .8rem; font-size: .8rem; color: var(--text);
    }

    .log-section {
      text-align: center; padding: 2rem 0;
    }
    .log-section p {
      color: var(--text-muted); font-size: .85rem; margin-top: .8rem;
    }

    /* ── ACTION BUTTONS ROW ── */
    .action-row {
      display: flex; gap: 1rem; justify-content: center;
      flex-wrap: wrap; margin-bottom: 1rem;
    }

    /* ── ACTIVE WORKOUT OVERLAY ── */
    .workout-active {
      display: none; position: fixed; inset: 0; z-index: 500;
      background: var(--dark);
      flex-direction: column;
    }
    .workout-active.open { display: flex; }

    .wa-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--card-border);
      flex-shrink: 0;
    }
    .wa-header h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem; color: #fff; letter-spacing: 1px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 60%;
    }
    .wa-timer {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.8rem; color: var(--neon); letter-spacing: 2px;
    }
    .wa-close {
      background: none; border: 1px solid #333; color: var(--text-muted);
      padding: .3rem .8rem; font-size: .75rem; text-transform: uppercase;
      letter-spacing: 1px; cursor: pointer; font-family: 'Inter', sans-serif;
      transition: all .3s; flex-shrink: 0;
    }
    .wa-close:hover { border-color: var(--accent); color: var(--accent); }

    .wa-progress-bar {
      height: 4px; background: #1a1a1a; flex-shrink: 0;
    }
    .wa-progress-fill {
      height: 100%; background: var(--neon);
      transition: width .3s ease;
    }

    .wa-body {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 2rem; text-align: center; overflow-y: auto;
    }
    .wa-step-label {
      font-size: .75rem; text-transform: uppercase; letter-spacing: 2px;
      color: var(--text-muted); margin-bottom: .5rem;
    }
    .wa-exercise-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2rem, 8vw, 4rem);
      color: #fff; letter-spacing: 2px; line-height: 1.1;
    }
    .wa-exercise-detail {
      display: flex; gap: .8rem; flex-wrap: wrap;
      justify-content: center; margin-top: 1rem;
    }
    .wa-exercise-detail span {
      font-size: .8rem; text-transform: uppercase; letter-spacing: 1px;
      color: var(--neon); background: rgba(200,255,0,.08);
      padding: .3rem .8rem;
    }
    .wa-exercise-notes {
      color: var(--text-muted); font-size: .9rem;
      margin-top: 1rem; max-width: 500px; line-height: 1.6;
    }

    .wa-footer {
      display: flex; align-items: center; justify-content: center;
      gap: 1rem; padding: 1.5rem; flex-shrink: 0;
      border-top: 1px solid var(--card-border);
    }
    .wa-nav-btn {
      background: transparent; color: #fff; padding: .8rem 1.8rem;
      font-weight: 700; font-size: .85rem; text-transform: uppercase;
      letter-spacing: 1px; border: 2px solid #333; cursor: pointer;
      font-family: 'Inter', sans-serif; transition: all .3s;
    }
    .wa-nav-btn:hover { border-color: var(--neon); color: var(--neon); }
    .wa-nav-btn:disabled { opacity: .3; cursor: not-allowed; }
    .wa-nav-btn.primary {
      background: var(--neon); color: #000; border-color: var(--neon);
      clip-path: polygon(0 0,100% 0,96% 100%,0% 100%);
    }
    .wa-nav-btn.primary:hover { background: #daff33; border-color: #daff33; }

    .wa-done {
      text-align: center;
    }
    .wa-done h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3rem; color: var(--neon); letter-spacing: 2px;
    }
    .wa-done p {
      color: var(--text-muted); margin-top: .5rem; font-size: .95rem;
    }
    .wa-done .wa-final-time {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.5rem; color: #fff; margin-top: 1rem; letter-spacing: 2px;
    }

    @media (max-width: 768px) {
      .detail-page { padding: 5rem 1rem 3rem; }
      .wa-header { padding: .8rem 1rem; }
      .wa-timer { font-size: 1.4rem; }
      .wa-footer { padding: 1rem; }
      .wa-nav-btn { padding: .7rem 1.2rem; font-size: .8rem; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="workouts.html" class="active">Workouts</a></li>
      <li><a href="health.html">Health</a></li>
      <li><a href="pace-calculator.html">PaceMe</a></li>
      <li><a href="events.html">Events</a></li>
    </ul>
    <div class="nav-right">
      <a href="login.html" class="nav-cta">Sign In</a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-close" id="mobileClose" aria-label="Close menu">&times;</button>
    <a href="dashboard.html" class="mobile-nav-link">Dashboard</a>
    <a href="workouts.html" class="mobile-nav-link">Workouts</a>
    <a href="health.html" class="mobile-nav-link">Health</a>
    <a href="pace-calculator.html" class="mobile-nav-link">PaceMe</a>
    <a href="race-history.html" class="mobile-nav-link">Races</a>
    <a href="events.html" class="mobile-nav-link">Events</a>
    <a href="profile.html" class="mobile-nav-link">Profile</a>
  </div>

  <div class="detail-page">
    <div class="detail-container">
      <a href="workouts.html" class="detail-back">&larr; Back to Workouts</a>

      <div id="workoutContent">
        <div class="dash-loading" style="text-align:center;padding:4rem;color:var(--text-muted);">Loading workout...</div>
      </div>
    </div>
  </div>

  <!-- Active Workout Overlay -->
  <div class="workout-active" id="workoutActive">
    <div class="wa-header">
      <h3 id="waTitle"></h3>
      <span class="wa-timer" id="waTimer">00:00</span>
      <button class="wa-close" id="waClose">End</button>
    </div>
    <div class="wa-progress-bar">
      <div class="wa-progress-fill" id="waProgress" style="width:0%"></div>
    </div>
    <div class="wa-body" id="waBody"></div>
    <div class="wa-footer" id="waFooter">
      <button class="wa-nav-btn" id="waPrev" disabled>Prev</button>
      <button class="wa-nav-btn primary" id="waNext">Next</button>
    </div>
  </div>

  <footer>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <p>&copy; 2025 HyroxSim. Train hard. Race harder.</p>
  </footer>

  <script type="module">
    import { initPage, showToast, formatTimeSec } from './js/shared.js'
    import { supabase } from './js/supabase-client.js'

    initPage()

    const params = new URLSearchParams(window.location.search)
    const workoutId = params.get('id')
    const container = document.getElementById('workoutContent')

    if (!workoutId) {
      container.innerHTML = `<div class="empty-state"><h3>Workout Not Found</h3><p>No workout ID provided.</p><a href="workouts.html" class="btn-primary" style="margin-top:1rem;">Browse Workouts</a></div>`
    } else {
      const { data: workout, error } = await supabase
        .from('workouts')
        .select('*')
        .eq('id', workoutId)
        .single()

      if (error || !workout) {
        container.innerHTML = `<div class="empty-state"><h3>Workout Not Found</h3><p>This workout doesn't exist or has been removed.</p><a href="workouts.html" class="btn-primary" style="margin-top:1rem;">Browse Workouts</a></div>`
      } else {
        document.title = `${workout.title} — HYROX SIM`
        const catClass = `cat-${workout.category}`
        const catLabel = workout.category?.replace('_', ' ')?.replace(/\b\w/g, c => c.toUpperCase()) || ''
        const diffClass = `diff-${workout.difficulty}`
        const diffLabel = workout.difficulty?.replace(/\b\w/g, c => c.toUpperCase()) || ''
        const stations = workout.stations || []

        let html = `
          <div class="detail-header fade-in">
            <h1>${workout.title}</h1>
            <div class="detail-meta">
              <span class="badge ${catClass}">${catLabel}</span>
              <span class="badge ${diffClass}" style="padding:.25rem .6rem;font-size:.7rem;text-transform:uppercase;letter-spacing:1px;font-weight:600;${workout.difficulty === 'beginner' ? 'background:rgba(0,200,83,.1);color:var(--success)' : workout.difficulty === 'intermediate' ? 'background:rgba(255,165,0,.1);color:#ffa500' : 'background:rgba(255,60,0,.1);color:var(--accent)'}">${diffLabel}</span>
              ${workout.duration_minutes ? `<span class="badge badge-muted">${workout.duration_minutes} min</span>` : ''}
            </div>
            ${workout.description ? `<p class="detail-desc">${workout.description}</p>` : ''}
          </div>
        `

        // Exercise List
        if (stations.length > 0) {
          html += `
            <div class="detail-section fade-in">
              <h2>Exercises <span class="accent">(${stations.length})</span></h2>
              <ul class="exercise-list">
                ${stations.map((s, i) => `
                  <li class="exercise-item">
                    <div class="exercise-num">${i + 1}</div>
                    <div class="exercise-info">
                      <h4>${s.name}</h4>
                      ${s.notes ? `<p>${s.notes}</p>` : ''}
                      <div class="ex-detail">
                        ${s.reps ? `<span>${s.reps}</span>` : ''}
                        ${s.duration ? `<span>${s.duration}</span>` : ''}
                        ${s.distance ? `<span>${s.distance}</span>` : ''}
                        ${s.rest ? `<span>Rest: ${s.rest}</span>` : ''}
                      </div>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>
          `
        }

        // Equipment
        if (workout.equipment?.length > 0) {
          html += `
            <div class="detail-section fade-in">
              <h2>Equipment <span class="accent">Needed</span></h2>
              <div class="equipment-list">
                ${workout.equipment.map(e => `<span class="equip-tag">${e}</span>`).join('')}
              </div>
            </div>
          `
        }

        // Action Buttons
        html += `
          <div class="log-section fade-in">
            <div class="action-row">
              ${stations.length > 0 ? `<button class="btn-primary" id="startBtn">Start Workout</button>` : ''}
              <button class="btn-secondary" id="logBtn">Log Completed</button>
            </div>
            <p id="logStatus"></p>
          </div>
        `

        container.innerHTML = html

        // Re-init fade
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible') })
        }, { threshold: 0.1 })
        container.querySelectorAll('.fade-in').forEach(el => observer.observe(el))

        // Log button
        document.getElementById('logBtn').addEventListener('click', async () => {
          const { data: { session } } = await supabase.auth.getSession()
          if (!session) {
            document.getElementById('logStatus').innerHTML = '<a href="login.html" style="color:var(--neon);">Sign in</a> to log workouts'
            return
          }

          const btn = document.getElementById('logBtn')
          btn.disabled = true
          btn.textContent = 'Logging...'

          const { error } = await supabase.from('workout_logs').insert({
            user_id: session.user.id,
            workout_id: workoutId,
            duration_seconds: workout.duration_minutes ? workout.duration_minutes * 60 : null,
            source: 'web'
          })

          if (error) {
            showToast('Error logging workout', 'error')
            btn.disabled = false
            btn.textContent = 'Log Completed'
          } else {
            btn.textContent = 'Logged!'
            showToast('Workout logged!', 'success')
            document.getElementById('logStatus').innerHTML = 'Workout added to your history. <a href="dashboard.html" style="color:var(--neon);">View Dashboard</a>'
          }
        })

        // ── Start Workout Flow ──
        const startBtn = document.getElementById('startBtn')
        if (startBtn && stations.length > 0) {
          let currentStep = 0
          let timerInterval = null
          let elapsedSeconds = 0

          const overlay = document.getElementById('workoutActive')
          const waTitle = document.getElementById('waTitle')
          const waTimer = document.getElementById('waTimer')
          const waBody = document.getElementById('waBody')
          const waProgress = document.getElementById('waProgress')
          const waFooter = document.getElementById('waFooter')
          const waPrev = document.getElementById('waPrev')
          const waNext = document.getElementById('waNext')

          function fmtTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0')
            const s = (sec % 60).toString().padStart(2, '0')
            return `${m}:${s}`
          }

          function renderStep() {
            const total = stations.length
            if (currentStep >= total) {
              // Done
              clearInterval(timerInterval)
              waProgress.style.width = '100%'
              waBody.innerHTML = `
                <div class="wa-done">
                  <h2>Workout Complete</h2>
                  <p>You crushed it.</p>
                  <div class="wa-final-time">${fmtTime(elapsedSeconds)}</div>
                </div>
              `
              waFooter.innerHTML = `
                <button class="wa-nav-btn" id="waDone">Close</button>
                <button class="wa-nav-btn primary" id="waLogDone">Log & Close</button>
              `
              document.getElementById('waDone').addEventListener('click', closeWorkout)
              document.getElementById('waLogDone').addEventListener('click', async () => {
                const { data: { session } } = await supabase.auth.getSession()
                if (!session) {
                  showToast('Sign in to log workouts', 'error')
                  closeWorkout()
                  return
                }
                await supabase.from('workout_logs').insert({
                  user_id: session.user.id,
                  workout_id: workoutId,
                  duration_seconds: elapsedSeconds,
                  source: 'web'
                })
                showToast('Workout logged!', 'success')
                closeWorkout()
              })
              return
            }

            const s = stations[currentStep]
            waProgress.style.width = `${((currentStep) / total) * 100}%`

            let detailHtml = ''
            if (s.reps) detailHtml += `<span>${s.reps}</span>`
            if (s.duration) detailHtml += `<span>${s.duration}</span>`
            if (s.distance) detailHtml += `<span>${s.distance}</span>`
            if (s.rest) detailHtml += `<span>Rest: ${s.rest}</span>`

            waBody.innerHTML = `
              <div class="wa-step-label">Exercise ${currentStep + 1} of ${total}</div>
              <div class="wa-exercise-name">${s.name}</div>
              ${detailHtml ? `<div class="wa-exercise-detail">${detailHtml}</div>` : ''}
              ${s.notes ? `<p class="wa-exercise-notes">${s.notes}</p>` : ''}
            `

            waPrev.disabled = currentStep === 0
            waNext.textContent = currentStep === total - 1 ? 'Finish' : 'Next'
          }

          function startTimer() {
            elapsedSeconds = 0
            waTimer.textContent = '00:00'
            timerInterval = setInterval(() => {
              elapsedSeconds++
              waTimer.textContent = fmtTime(elapsedSeconds)
            }, 1000)
          }

          function closeWorkout() {
            clearInterval(timerInterval)
            overlay.classList.remove('open')
            currentStep = 0
            elapsedSeconds = 0
          }

          startBtn.addEventListener('click', () => {
            waTitle.textContent = workout.title
            currentStep = 0
            // Restore footer buttons
            waFooter.innerHTML = `
              <button class="wa-nav-btn" id="waPrev" disabled>Prev</button>
              <button class="wa-nav-btn primary" id="waNext">Next</button>
            `
            // Re-bind after innerHTML reset
            const prevBtn = document.getElementById('waPrev')
            const nextBtn = document.getElementById('waNext')
            prevBtn.addEventListener('click', () => {
              if (currentStep > 0) { currentStep--; renderStep() }
            })
            nextBtn.addEventListener('click', () => {
              currentStep++
              renderStep()
            })
            overlay.classList.add('open')
            renderStep()
            startTimer()
          })

          document.getElementById('waClose').addEventListener('click', closeWorkout)
        }
      }
    }
  </script>
</body>
</html>
