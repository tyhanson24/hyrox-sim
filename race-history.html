<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Race History â€” HYROX SIM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    .race-page {
      min-height: 100vh; padding: 6rem 2rem 4rem;
      background: radial-gradient(ellipse at 50% 0%, rgba(200,255,0,.04) 0%, transparent 60%), var(--dark);
    }
    .race-container { max-width: 1000px; margin: 0 auto; }

    .race-hero { text-align: center; margin-bottom: 2rem; }
    .race-hero h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      color: #fff; letter-spacing: 2px;
    }
    .race-hero h1 .accent { color: var(--neon); }
    .race-hero p { color: var(--text-muted); margin-top: .5rem; max-width: 500px; margin-inline: auto; }

    .race-actions { text-align: center; margin-bottom: 3rem; }

    /* Race Form */
    .race-form-section {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 2rem; display: none;
    }
    .race-form-section.show { display: block; }
    .race-form-section h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem; color: #fff; letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }
    .race-form-section h2 .accent { color: var(--neon); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    .time-inputs { display: flex; gap: .3rem; align-items: center; }
    .time-inputs input { width: 60px; text-align: center; }
    .time-inputs span { color: var(--text-muted); }

    .splits-section { margin-top: 1.5rem; }
    .splits-section h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.2rem; color: #fff; margin-bottom: 1rem;
    }
    .splits-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: .5rem;
    }
    .split-input-row {
      display: flex; align-items: center; gap: .5rem;
    }
    .split-input-row label {
      font-size: .75rem; color: var(--text-muted); width: 130px;
      flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .split-input-row input {
      width: 50px; text-align: center; padding: .5rem;
    }

    /* Race List */
    .race-list { display: flex; flex-direction: column; gap: 1rem; }
    .race-card {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 1.5rem; transition: border-color .3s;
      cursor: pointer;
    }
    .race-card:hover { border-color: #444; }
    .race-card.expanded { border-color: var(--neon); }
    .race-card-header {
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: .5rem;
    }
    .race-card h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.4rem; color: #fff; letter-spacing: 1px;
    }
    .race-card-time {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.6rem; color: var(--neon);
    }
    .race-card-meta {
      display: flex; gap: 1rem; margin-top: .5rem; flex-wrap: wrap;
    }
    .race-card-meta span {
      font-size: .8rem; color: var(--text-muted);
    }
    .race-card-meta strong { color: #fff; }
    .pr-badge {
      background: rgba(255,215,0,.15); color: #ffd700;
      padding: .15rem .5rem; font-size: .65rem;
      text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
    }

    .race-detail { display: none; margin-top: 1.5rem; }
    .race-card.expanded .race-detail { display: block; }
    .race-chart-container {
      height: 250px; margin-top: 1rem;
    }

    /* Analytics */
    .analytics-section {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 2rem;
    }
    .analytics-section h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem; color: #fff; letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }
    .analytics-section h2 .accent { color: var(--neon); }
    .analytics-chart-container { height: 300px; }

    @media (max-width: 768px) {
      .race-page { padding: 5rem 1rem 3rem; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .splits-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="workouts.html">Workouts</a></li>
      <li><a href="pace-calculator.html">PaceMe</a></li>
      <li><a href="race-history.html" class="active">Races</a></li>
    </ul>
    <div class="nav-right">
      <a href="login.html" class="nav-cta">Sign In</a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-close" id="mobileClose" aria-label="Close menu">&times;</button>
    <a href="dashboard.html" class="mobile-nav-link">Dashboard</a>
    <a href="workouts.html" class="mobile-nav-link">Workouts</a>
    <a href="index.html#timer" class="mobile-nav-link">Sim Timer</a>
    <a href="pace-calculator.html" class="mobile-nav-link">PaceMe</a>
    <a href="race-history.html" class="mobile-nav-link">Races</a>
    <a href="training-plans.html" class="mobile-nav-link">Training Plans</a>
    <a href="profile.html" class="mobile-nav-link">Profile</a>
  </div>

  <div class="race-page">
    <div class="race-container">

      <div class="race-hero fade-in">
        <h1>RACE <span class="accent">HISTORY</span></h1>
        <p>Log your official Hyrox race results, track PRs, and analyze your performance over time.</p>
      </div>

      <div class="race-actions fade-in">
        <button class="btn-primary" id="addRaceBtn">+ Log New Race</button>
      </div>

      <!-- Add Race Form -->
      <div class="race-form-section" id="raceForm">
        <h2>Log <span class="accent">Race Result</span></h2>
        <form id="raceFormEl">
          <div class="form-row">
            <div class="form-group">
              <label>Race Name <span class="required">*</span></label>
              <input type="text" class="form-input" id="raceName" placeholder="e.g. Hyrox Chicago 2025" required>
            </div>
            <div class="form-group">
              <label>Race Date <span class="required">*</span></label>
              <input type="date" class="form-input" id="raceDate" required>
            </div>
          </div>
          <div class="form-row-3">
            <div class="form-group">
              <label>Location</label>
              <input type="text" class="form-input" id="raceLocation" placeholder="City, Country">
            </div>
            <div class="form-group">
              <label>Division</label>
              <select class="form-input" id="raceDivision">
                <option value="">Select</option>
                <option value="Men Open">Men Open</option>
                <option value="Women Open">Women Open</option>
                <option value="Men Pro">Men Pro</option>
                <option value="Women Pro">Women Pro</option>
                <option value="Men Doubles">Men Doubles</option>
                <option value="Women Doubles">Women Doubles</option>
                <option value="Mixed Doubles">Mixed Doubles</option>
              </select>
            </div>
            <div class="form-group">
              <label>Overall Time <span class="required">*</span></label>
              <div class="time-inputs">
                <input type="number" class="form-input" id="raceH" min="0" max="4" placeholder="H">
                <span>:</span>
                <input type="number" class="form-input" id="raceM" min="0" max="59" placeholder="MM">
                <span>:</span>
                <input type="number" class="form-input" id="raceS" min="0" max="59" placeholder="SS">
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Overall Rank</label>
              <input type="number" class="form-input" id="raceRank" min="1" placeholder="e.g. 42">
            </div>
            <div class="form-group">
              <label>Age Group Rank</label>
              <input type="number" class="form-input" id="ageRank" min="1" placeholder="e.g. 8">
            </div>
          </div>

          <div class="splits-section">
            <h3>Splits (Optional)</h3>
            <div class="splits-grid" id="splitsGrid"></div>
          </div>

          <div class="form-group" style="margin-top:1.5rem;">
            <label>Notes</label>
            <textarea class="form-input" id="raceNotes" placeholder="How did it go? Any takeaways?" rows="3"></textarea>
          </div>

          <div style="display:flex;gap:1rem;margin-top:1.5rem;">
            <button type="submit" class="btn-primary" id="saveRaceBtn">Save Race</button>
            <button type="button" class="btn-secondary" id="cancelRaceBtn" style="padding:.7rem 1.5rem;font-size:.85rem;">Cancel</button>
          </div>
        </form>
      </div>

      <!-- Improvement Chart -->
      <div class="analytics-section fade-in" id="analyticsSection" style="display:none;">
        <h2>Performance <span class="accent">Over Time</span></h2>
        <div class="analytics-chart-container">
          <canvas id="improvementChart"></canvas>
        </div>
      </div>

      <!-- Race List -->
      <div class="race-list" id="raceList">
        <div style="text-align:center;padding:3rem;color:var(--text-muted);">Loading races...</div>
      </div>

    </div>
  </div>

  <footer>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <p>&copy; 2025 HyroxSim. Train hard. Race harder.</p>
  </footer>

  <script type="module">
    import { initPage, requireAuth, showToast, formatTimeSec } from './js/shared.js'
    import { supabase } from './js/supabase-client.js'

    initPage()
    const session = await requireAuth()
    if (!session) throw new Error('Not authenticated')
    const userId = session.user.id

    const segmentNames = [
      'Run 1', 'SkiErg', 'Run 2', 'Sled Push',
      'Run 3', 'Sled Pull', 'Run 4', 'Burpee Broad Jumps',
      'Run 5', 'Rowing', 'Run 6', 'Farmers Carry',
      'Run 7', 'Sandbag Lunges', 'Run 8', 'Wall Balls'
    ]

    // Build splits inputs
    const splitsGrid = document.getElementById('splitsGrid')
    segmentNames.forEach((name, i) => {
      splitsGrid.innerHTML += `
        <div class="split-input-row">
          <label>${name}</label>
          <input type="number" class="form-input split-m" data-idx="${i}" min="0" max="59" placeholder="M">
          <span style="color:var(--text-muted)">:</span>
          <input type="number" class="form-input split-s" data-idx="${i}" min="0" max="59" placeholder="SS">
        </div>
      `
    })

    // Toggle form
    const formSection = document.getElementById('raceForm')
    document.getElementById('addRaceBtn').addEventListener('click', () => {
      formSection.classList.toggle('show')
    })
    document.getElementById('cancelRaceBtn').addEventListener('click', () => {
      formSection.classList.remove('show')
    })

    // Save race
    document.getElementById('raceFormEl').addEventListener('submit', async (e) => {
      e.preventDefault()
      const btn = document.getElementById('saveRaceBtn')
      btn.disabled = true
      btn.textContent = 'Saving...'

      const h = parseInt(document.getElementById('raceH').value) || 0
      const m = parseInt(document.getElementById('raceM').value) || 0
      const s = parseInt(document.getElementById('raceS').value) || 0
      const totalSecs = h * 3600 + m * 60 + s

      if (totalSecs === 0) {
        showToast('Please enter a race time', 'error')
        btn.disabled = false; btn.textContent = 'Save Race'
        return
      }

      // Collect splits
      const splits = []
      segmentNames.forEach((name, i) => {
        const sm = document.querySelector(`.split-m[data-idx="${i}"]`)?.value
        const ss = document.querySelector(`.split-s[data-idx="${i}"]`)?.value
        if (sm || ss) {
          splits.push({
            station: name,
            time_seconds: (parseInt(sm) || 0) * 60 + (parseInt(ss) || 0)
          })
        }
      })

      const { error } = await supabase.from('race_results').insert({
        user_id: userId,
        race_name: document.getElementById('raceName').value.trim(),
        race_date: document.getElementById('raceDate').value,
        location: document.getElementById('raceLocation').value.trim() || null,
        division: document.getElementById('raceDivision').value || null,
        overall_time_seconds: totalSecs,
        overall_rank: parseInt(document.getElementById('raceRank').value) || null,
        age_group_rank: parseInt(document.getElementById('ageRank').value) || null,
        splits: splits.length > 0 ? splits : null,
        notes: document.getElementById('raceNotes').value.trim() || null
      })

      if (error) {
        showToast('Error saving race: ' + error.message, 'error')
      } else {
        showToast('Race result saved!', 'success')
        formSection.classList.remove('show')
        document.getElementById('raceFormEl').reset()
        loadRaces()
      }

      btn.disabled = false
      btn.textContent = 'Save Race'
    })

    // Load races
    const splitCharts = {}
    async function loadRaces() {
      const { data: races, error } = await supabase
        .from('race_results')
        .select('*')
        .eq('user_id', userId)
        .order('race_date', { ascending: false })

      const raceList = document.getElementById('raceList')

      if (!races || races.length === 0) {
        raceList.innerHTML = `
          <div class="empty-state">
            <h3>No Races Logged</h3>
            <p>Log your first official Hyrox race result to start tracking your progress.</p>
          </div>
        `
        document.getElementById('analyticsSection').style.display = 'none'
        return
      }

      // Find PR
      const bestTime = Math.min(...races.map(r => r.overall_time_seconds))

      raceList.innerHTML = races.map((r, idx) => {
        const isPR = r.overall_time_seconds === bestTime
        const date = new Date(r.race_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })

        return `
          <div class="race-card fade-in" data-idx="${idx}">
            <div class="race-card-header">
              <div>
                <h3>${r.race_name} ${isPR ? '<span class="pr-badge">PR</span>' : ''}</h3>
                <div class="race-card-meta">
                  <span>${date}</span>
                  ${r.location ? `<span>${r.location}</span>` : ''}
                  ${r.division ? `<span>${r.division}</span>` : ''}
                  ${r.overall_rank ? `<span>Rank: <strong>#${r.overall_rank}</strong></span>` : ''}
                  ${r.age_group_rank ? `<span>AG: <strong>#${r.age_group_rank}</strong></span>` : ''}
                </div>
              </div>
              <div class="race-card-time">${formatTimeSec(r.overall_time_seconds)}</div>
            </div>
            <div class="race-detail">
              ${r.notes ? `<p style="color:var(--text-muted);font-size:.9rem;margin-bottom:1rem;font-style:italic;">"${r.notes}"</p>` : ''}
              ${r.splits && r.splits.length > 0 ? `
                <div class="race-chart-container">
                  <canvas id="raceChart${idx}"></canvas>
                </div>
              ` : '<p style="color:var(--text-muted);font-size:.85rem;">No splits recorded for this race.</p>'}
            </div>
          </div>
        `
      }).join('')

      // Toggle expand
      raceList.querySelectorAll('.race-card').forEach(card => {
        card.addEventListener('click', () => {
          const wasExpanded = card.classList.contains('expanded')
          card.classList.toggle('expanded')
          if (!wasExpanded) {
            const idx = card.dataset.idx
            const race = races[idx]
            if (race.splits?.length > 0 && !splitCharts[idx]) {
              renderSplitChart(idx, race.splits)
            }
          }
        })
      })

      // Fade in
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible') })
      }, { threshold: 0.1 })
      raceList.querySelectorAll('.fade-in').forEach(el => observer.observe(el))

      // Improvement chart
      if (races.length >= 2) {
        renderImprovementChart(races)
      }
    }

    function renderSplitChart(idx, splits) {
      const ctx = document.getElementById(`raceChart${idx}`)
      if (!ctx) return

      const labels = splits.map(s => s.station)
      const data = splits.map(s => s.time_seconds)
      const maxTime = Math.max(...data)
      const colors = splits.map(s => s.station.startsWith('Run') ? 'rgba(200,255,0,.6)' : 'rgba(255,60,0,.6)')
      const borderColors = splits.map(s => s.station.startsWith('Run') ? '#c8ff00' : '#ff3c00')

      splitCharts[idx] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => formatTimeSec(ctx.raw)
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#888', font: { size: 9 }, maxRotation: 45 },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: '#888',
                callback: (v) => formatTimeSec(v)
              },
              grid: { color: 'rgba(255,255,255,.05)' }
            }
          }
        }
      })
    }

    function renderImprovementChart(races) {
      document.getElementById('analyticsSection').style.display = 'block'
      const sorted = [...races].sort((a, b) => new Date(a.race_date) - new Date(b.race_date))
      const labels = sorted.map(r => new Date(r.race_date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }))
      const data = sorted.map(r => r.overall_time_seconds)

      const ctx = document.getElementById('improvementChart')
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Race Time',
            data,
            borderColor: '#c8ff00',
            backgroundColor: 'rgba(200,255,0,.1)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: '#c8ff00',
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `Time: ${formatTimeSec(ctx.raw)}`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#888' },
              grid: { display: false }
            },
            y: {
              reverse: true,
              ticks: {
                color: '#888',
                callback: (v) => formatTimeSec(v)
              },
              grid: { color: 'rgba(255,255,255,.05)' }
            }
          }
        }
      })
    }

    loadRaces()
  </script>
</body>
</html>
