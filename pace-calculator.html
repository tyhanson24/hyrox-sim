<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PaceMe Calculator — HYROX SIM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/global.css">
  <style>
    .pace-page {
      min-height: 100vh; padding: 6rem 2rem 4rem;
      background: radial-gradient(ellipse at 50% 0%, rgba(200,255,0,.04) 0%, transparent 60%), var(--dark);
    }
    .pace-container { max-width: 900px; margin: 0 auto; }

    .pace-hero { text-align: center; margin-bottom: 3rem; }
    .pace-hero h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      color: #fff; letter-spacing: 2px;
    }
    .pace-hero h1 .accent { color: var(--neon); }
    .pace-hero p { color: var(--text-muted); margin-top: .5rem; max-width: 550px; margin-inline: auto; line-height: 1.6; }

    /* Input Section */
    .pace-input-section {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 2rem;
    }
    .pace-input-row {
      display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;
    }
    .pace-time-inputs {
      display: flex; gap: .5rem; align-items: center;
    }
    .pace-time-inputs input {
      width: 70px; text-align: center;
    }
    .pace-time-inputs span { color: var(--text-muted); font-size: 1.2rem; }
    .pace-input-row .form-group { flex: 1; min-width: 150px; }
    .calculate-btn {
      background: var(--neon); color: #000; padding: .9rem 2rem;
      font-weight: 700; font-size: .85rem; text-transform: uppercase;
      letter-spacing: 1.5px; border: none; cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: background .3s;
      white-space: nowrap;
    }
    .calculate-btn:hover { background: #daff33; }

    /* Results */
    .pace-results { display: none; }
    .pace-results.show { display: block; }

    .pace-summary {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem; margin-bottom: 2rem;
    }
    .pace-summary-card {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 1.2rem; text-align: center;
    }
    .pace-summary-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem; color: var(--neon);
    }
    .pace-summary-label {
      font-size: .7rem; text-transform: uppercase; letter-spacing: 1.5px;
      color: var(--text-muted); margin-top: .2rem;
    }

    /* Breakdown Table */
    .pace-breakdown {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 2rem;
    }
    .pace-breakdown h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem; color: #fff; letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }
    .pace-breakdown h2 .accent { color: var(--neon); }

    .pace-table { width: 100%; border-collapse: collapse; }
    .pace-table th {
      text-align: left; padding: .8rem; font-size: .7rem;
      text-transform: uppercase; letter-spacing: 1.5px;
      color: var(--text-muted); border-bottom: 1px solid var(--card-border);
    }
    .pace-table td {
      padding: .8rem; border-bottom: 1px solid rgba(34,34,34,.5);
      font-size: .9rem;
    }
    .pace-table tr:hover td { background: rgba(200,255,0,.02); }
    .pace-table .station-name { color: #fff; font-weight: 500; }
    .pace-table .station-time {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem; color: var(--neon);
    }
    .pace-table .station-cumulative { color: var(--text-muted); font-size: .85rem; }
    .pace-table .run-row { background: rgba(200,255,0,.02); }

    .pace-editable {
      background: transparent; border: 1px solid transparent;
      color: var(--neon); font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem; width: 80px; text-align: center;
      padding: .2rem; transition: border-color .3s;
    }
    .pace-editable:focus {
      border-color: var(--neon); outline: none;
      background: rgba(200,255,0,.05);
    }

    /* Bar Chart */
    .pace-chart {
      background: var(--card); border: 1px solid var(--card-border);
      padding: 2rem; margin-bottom: 2rem;
    }
    .pace-chart h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.5rem; color: #fff; letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }
    .pace-chart h2 .accent { color: var(--neon); }
    .chart-bars { display: flex; flex-direction: column; gap: .4rem; }
    .chart-bar-row {
      display: flex; align-items: center; gap: .8rem;
    }
    .chart-bar-label {
      width: 120px; font-size: .75rem; color: var(--text-muted);
      text-align: right; flex-shrink: 0;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .chart-bar-track {
      flex: 1; height: 24px; background: rgba(255,255,255,.03);
      position: relative;
    }
    .chart-bar-fill {
      height: 100%; transition: width .4s ease;
      display: flex; align-items: center; justify-content: flex-end;
      padding-right: .5rem;
      font-size: .7rem; font-weight: 600;
      white-space: nowrap;
    }
    .chart-bar-fill.run { background: rgba(200,255,0,.3); color: var(--neon); }
    .chart-bar-fill.station { background: rgba(255,60,0,.3); color: var(--accent); }

    .save-pace-section { text-align: center; padding: 1rem 0; }
    .save-pace-section p { color: var(--text-muted); font-size: .85rem; margin-top: .5rem; }

    @media (max-width: 768px) {
      .pace-page { padding: 5rem 1rem 3rem; }
      .pace-input-row { flex-direction: column; }
      .chart-bar-label { width: 80px; font-size: .65rem; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <ul class="nav-links">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="workouts.html">Workouts</a></li>
      <li><a href="health.html">Health</a></li>
      <li><a href="pace-calculator.html" class="active">PaceMe</a></li>
      <li><a href="race-history.html">Races</a></li>
      <li><a href="events.html">Events</a></li>
    </ul>
    <div class="nav-right">
      <a href="login.html" class="nav-cta">Sign In</a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-close" id="mobileClose" aria-label="Close menu">&times;</button>
    <a href="dashboard.html" class="mobile-nav-link">Dashboard</a>
    <a href="workouts.html" class="mobile-nav-link">Workouts</a>
    <a href="health.html" class="mobile-nav-link">Health</a>
    <a href="pace-calculator.html" class="mobile-nav-link">PaceMe</a>
    <a href="race-history.html" class="mobile-nav-link">Races</a>
    <a href="events.html" class="mobile-nav-link">Events</a>
    <a href="training-plans.html" class="mobile-nav-link">Training Plans</a>
    <a href="profile.html" class="mobile-nav-link">Profile</a>
  </div>

  <div class="pace-page">
    <div class="pace-container">

      <div class="pace-hero fade-in">
        <h1>PACE<span class="accent">ME</span></h1>
        <p>Enter your goal time and we'll calculate a detailed pacing plan across all 16 segments — weighted by real Hyrox race data.</p>
      </div>

      <div class="pace-input-section fade-in">
        <div class="pace-input-row">
          <div class="form-group">
            <label>Goal Time</label>
            <div class="pace-time-inputs">
              <input type="number" class="form-input" id="goalHours" min="0" max="4" placeholder="H" value="1">
              <span>:</span>
              <input type="number" class="form-input" id="goalMins" min="0" max="59" placeholder="MM" value="30">
              <span>:</span>
              <input type="number" class="form-input" id="goalSecs" min="0" max="59" placeholder="SS" value="0">
            </div>
          </div>
          <div class="form-group">
            <label>Division</label>
            <select class="form-input" id="division">
              <option value="men_open">Men Open</option>
              <option value="women_open">Women Open</option>
              <option value="men_pro">Men Pro</option>
              <option value="women_pro">Women Pro</option>
            </select>
          </div>
          <button class="calculate-btn" id="calcBtn">Calculate Pace</button>
        </div>
      </div>

      <div class="pace-results" id="paceResults">
        <div class="pace-summary" id="paceSummary"></div>

        <div class="pace-breakdown">
          <h2>Segment <span class="accent">Breakdown</span></h2>
          <table class="pace-table">
            <thead>
              <tr><th>#</th><th>Segment</th><th>Target Time</th><th>Cumulative</th></tr>
            </thead>
            <tbody id="paceBody"></tbody>
          </table>
        </div>

        <div class="pace-chart">
          <h2>Visual <span class="accent">Pacing</span></h2>
          <div class="chart-bars" id="paceChart"></div>
        </div>

        <div class="save-pace-section">
          <button class="btn-primary" id="savePace">Save Pace Plan</button>
          <p id="saveStatus"></p>
        </div>
      </div>

    </div>
  </div>

  <footer>
    <a href="index.html" class="logo">HYROX<span>SIM</span></a>
    <p>&copy; 2025 HyroxSim. Train hard. Race harder.</p>
  </footer>

  <script type="module">
    import { initPage, showToast, formatTimeSec } from './js/shared.js'
    import { supabase } from './js/supabase-client.js'

    initPage()

    // ── Hyrox Segment Data ──
    // Weights represent typical % of total race time per segment
    // Based on aggregated Hyrox race data analysis
    const segments = [
      { name: 'Run 1 — 1km', type: 'run', weight: 5.8 },
      { name: 'SkiErg — 1000m', type: 'station', weight: 5.5 },
      { name: 'Run 2 — 1km', type: 'run', weight: 6.0 },
      { name: 'Sled Push — 50m', type: 'station', weight: 4.8 },
      { name: 'Run 3 — 1km', type: 'run', weight: 6.2 },
      { name: 'Sled Pull — 50m', type: 'station', weight: 5.2 },
      { name: 'Run 4 — 1km', type: 'run', weight: 6.3 },
      { name: 'Burpee Broad Jumps — 80m', type: 'station', weight: 7.5 },
      { name: 'Run 5 — 1km', type: 'run', weight: 6.5 },
      { name: 'Rowing — 1000m', type: 'station', weight: 6.0 },
      { name: 'Run 6 — 1km', type: 'run', weight: 6.8 },
      { name: 'Farmers Carry — 200m', type: 'station', weight: 5.8 },
      { name: 'Run 7 — 1km', type: 'run', weight: 7.0 },
      { name: 'Sandbag Lunges — 100m', type: 'station', weight: 8.2 },
      { name: 'Run 8 — 1km', type: 'run', weight: 7.5 },
      { name: 'Wall Balls — 100 reps', type: 'station', weight: 4.9 }
    ]

    // Division adjustments (modifies station vs run split)
    const divisionMods = {
      men_open: { runMod: 1.0, stationMod: 1.0 },
      women_open: { runMod: 0.95, stationMod: 1.05 },
      men_pro: { runMod: 1.02, stationMod: 0.98 },
      women_pro: { runMod: 0.97, stationMod: 1.03 }
    }

    let currentPlan = null

    function formatTime(totalSecs) {
      const h = Math.floor(totalSecs / 3600)
      const m = Math.floor((totalSecs % 3600) / 60)
      const s = Math.round(totalSecs % 60)
      if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
      return `${m}:${String(s).padStart(2,'0')}`
    }

    function calculate() {
      const hours = parseInt(document.getElementById('goalHours').value) || 0
      const mins = parseInt(document.getElementById('goalMins').value) || 0
      const secs = parseInt(document.getElementById('goalSecs').value) || 0
      const totalGoalSecs = hours * 3600 + mins * 60 + secs

      if (totalGoalSecs < 300) return

      const division = document.getElementById('division').value
      const mods = divisionMods[division]

      // Normalize weights
      const totalWeight = segments.reduce((sum, s) => sum + s.weight, 0)

      // Calculate target time per segment
      const plan = segments.map(s => {
        const mod = s.type === 'run' ? mods.runMod : mods.stationMod
        const targetSecs = (s.weight / totalWeight) * totalGoalSecs * mod
        return { ...s, targetSecs }
      })

      // Re-normalize to match exact goal
      const planTotal = plan.reduce((sum, s) => sum + s.targetSecs, 0)
      const factor = totalGoalSecs / planTotal
      plan.forEach(s => s.targetSecs *= factor)

      currentPlan = plan

      // Summary
      const totalRunSecs = plan.filter(s => s.type === 'run').reduce((sum, s) => sum + s.targetSecs, 0)
      const totalStationSecs = plan.filter(s => s.type === 'station').reduce((sum, s) => sum + s.targetSecs, 0)
      const avgRunPace = totalRunSecs / 8 // 8 x 1km

      document.getElementById('paceSummary').innerHTML = `
        <div class="pace-summary-card">
          <div class="pace-summary-value">${formatTime(totalGoalSecs)}</div>
          <div class="pace-summary-label">Goal Time</div>
        </div>
        <div class="pace-summary-card">
          <div class="pace-summary-value">${formatTime(Math.round(totalRunSecs))}</div>
          <div class="pace-summary-label">Total Running</div>
        </div>
        <div class="pace-summary-card">
          <div class="pace-summary-value">${formatTime(Math.round(totalStationSecs))}</div>
          <div class="pace-summary-label">Total Stations</div>
        </div>
        <div class="pace-summary-card">
          <div class="pace-summary-value">${formatTime(Math.round(avgRunPace))}/km</div>
          <div class="pace-summary-label">Avg Run Pace</div>
        </div>
      `

      // Table
      let cumulative = 0
      document.getElementById('paceBody').innerHTML = plan.map((s, i) => {
        cumulative += s.targetSecs
        const rowClass = s.type === 'run' ? 'run-row' : ''
        return `
          <tr class="${rowClass}">
            <td style="color:var(--text-muted)">${i + 1}</td>
            <td class="station-name">${s.name}</td>
            <td class="station-time">${formatTime(Math.round(s.targetSecs))}</td>
            <td class="station-cumulative">${formatTime(Math.round(cumulative))}</td>
          </tr>
        `
      }).join('')

      // Bar Chart
      const maxSecs = Math.max(...plan.map(s => s.targetSecs))
      document.getElementById('paceChart').innerHTML = plan.map(s => {
        const pct = (s.targetSecs / maxSecs) * 100
        const barClass = s.type === 'run' ? 'run' : 'station'
        const label = s.name.split('—')[0].trim()
        return `
          <div class="chart-bar-row">
            <div class="chart-bar-label">${label}</div>
            <div class="chart-bar-track">
              <div class="chart-bar-fill ${barClass}" style="width:${pct}%">
                ${formatTime(Math.round(s.targetSecs))}
              </div>
            </div>
          </div>
        `
      }).join('')

      document.getElementById('paceResults').classList.add('show')
    }

    document.getElementById('calcBtn').addEventListener('click', calculate)

    // Auto-calculate on load if profile has target time
    const { data: { session } } = await supabase.auth.getSession()
    if (session) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('target_time_seconds, division')
        .eq('id', session.user.id)
        .single()

      if (profile?.target_time_seconds) {
        const t = profile.target_time_seconds
        document.getElementById('goalHours').value = Math.floor(t / 3600)
        document.getElementById('goalMins').value = Math.floor((t % 3600) / 60)
        document.getElementById('goalSecs').value = t % 60
        if (profile.division) {
          const sel = document.getElementById('division')
          if ([...sel.options].some(o => o.value === profile.division)) {
            sel.value = profile.division
          }
        }
        calculate()
      }
    }

    // Save Pace Plan
    document.getElementById('savePace').addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        document.getElementById('saveStatus').innerHTML = '<a href="login.html" style="color:var(--neon);">Sign in</a> to save your pace plan'
        return
      }

      if (!currentPlan) return

      const hours = parseInt(document.getElementById('goalHours').value) || 0
      const mins = parseInt(document.getElementById('goalMins').value) || 0
      const secs = parseInt(document.getElementById('goalSecs').value) || 0
      const targetSeconds = hours * 3600 + mins * 60 + secs

      // Save to profile
      const { error } = await supabase.from('profiles').update({
        target_time_seconds: targetSeconds,
        updated_at: new Date().toISOString()
      }).eq('id', session.user.id)

      if (error) {
        showToast('Error saving pace plan', 'error')
      } else {
        showToast('Pace plan saved to profile!', 'success')
        document.getElementById('saveStatus').textContent = 'Target time saved to your profile.'
      }
    })
  </script>
</body>
</html>
